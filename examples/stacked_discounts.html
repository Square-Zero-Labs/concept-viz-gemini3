<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizing Stacked Discounts</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: white;
            font-size: 18px;
        }

        h1#title {
            margin: 0;
            padding: 24px 0 8px;
            text-align: center;
            font-size: 2.4rem;
            letter-spacing: 0.5px;
            color: #e2e8f0;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 320px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: flex;
            justify-content: space-between;
            font-size: 1.05rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        .value-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1rem;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 18px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        #slider1::-webkit-slider-runnable-track {
            background: linear-gradient(90deg, #f472b6, #f472b6);
        }
        
        #slider2::-webkit-slider-runnable-track {
            background: linear-gradient(90deg, #facc15, #facc15);
        }

        .math-summary {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 1rem;
            line-height: 1.6;
        }

        .neon-text-pink { color: #f472b6; }
        .neon-text-yellow { color: #facc15; }
        .neon-text-cyan { color: #34d399; }

        #viz-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 40px 40px 380px;
            box-sizing: border-box;
        }

        svg {
            width: 100%;
            height: 100%;
            max-width: 1200px;
            max-height: 800px;
        }

        text {
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
        }
    </style>
</head>
<body>

    <h1 id="title">Black Friday Math</h1>

    <div id="controls">
        <div class="control-group">
            <label for="discount1">
                <span class="neon-text-pink">Discount 1</span>
                <span id="val1" class="value-display neon-text-pink">20%</span>
            </label>
            <input type="range" id="discount1" min="0" max="90" value="20">
        </div>

        <div class="control-group">
            <label for="discount2">
                <span class="neon-text-yellow">Discount 2</span>
                <span id="val2" class="value-display neon-text-yellow">30%</span>
            </label>
            <input type="range" id="discount2" min="0" max="90" value="30">
        </div>

        <div class="math-summary">
            <div style="margin-bottom: 5px;">Mistaken Logic: <span id="naive-calc">20% + 30% = 50%</span></div>
            <div style="font-weight:bold; font-size: 1rem;">Actual Savings: <span id="actual-calc" class="neon-text-cyan">44%</span></div>
            <div style="margin-top:5px; font-size: 0.8rem; color: #94a3b8;">The "Stacking Gap": <span id="gap-calc">6%</span></div>
        </div>
    </div>

    <div id="viz-container"></div>

    <script>
        // Setup dimensions
        const container = document.getElementById('viz-container');
        const width = 1000;
        const height = 700;
        const margin = { top: 80, right: 140, bottom: 120, left: 140 };

        const svg = d3.select("#viz-container")
            .append("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        // Colors
        const cCyan = "#22c55e";
        const cPink = "#f472b6";
        const cYellow = "#facc15";
        const cPurple = "#c084fc";
        const cBg = "#0f172a";
        const cGhost = "#475569";

        // Initial State
        let d1 = 0.20;
        let d2 = 0.30;

        // Scales and layout helpers
        const yScale = d3.scaleLinear()
            .domain([0, 1])
            .range([height - margin.bottom, margin.top]); // 0 at bottom, 1 at top

        const barWidth = 140;
        const xBar = width / 2 - barWidth / 2;
        
        // --- Draw Static Elements ---

        // Definitions for glows
        const defs = svg.append("defs");
        const filter = defs.append("filter")
            .attr("id", "glow");
        filter.append("feGaussianBlur")
            .attr("stdDeviation", "3.5")
            .attr("result", "coloredBlur");
        const feMerge = filter.append("feMerge");
        feMerge.append("feMergeNode").attr("in", "coloredBlur");
        feMerge.append("feMergeNode").attr("in", "SourceGraphic");

        // Main Group
        const mainG = svg.append("g");

        // 1. Full Price Outline (Ghost Bar)
        mainG.append("rect")
            .attr("x", xBar)
            .attr("y", yScale(1))
            .attr("width", barWidth)
            .attr("height", yScale(0) - yScale(1))
            .attr("fill", "none")
            .attr("stroke", "white")
            .attr("stroke-opacity", 0.2)
            .attr("stroke-width", 2)
            .attr("rx", 8);

        // 2. The Current Price Bar (Cyan)
        const priceBar = mainG.append("rect")
            .attr("x", xBar)
            .attr("fill", cCyan)
            .attr("opacity", 0.9)
            .attr("filter", "url(#glow)")
            .attr("rx", 8);

        // 3. Discount 1 Chunk (Pink)
        const d1Bar = mainG.append("rect")
            .attr("x", xBar)
            .attr("fill", cPink)
            .attr("opacity", 0.4)
            .attr("rx", 8);

        // 4. Discount 2 Chunk (Yellow)
        const d2Bar = mainG.append("rect")
            .attr("x", xBar)
            .attr("fill", cYellow)
            .attr("opacity", 0.8)
            .attr("rx", 8);

        // 5. The "Gap" (The Naive Mistake) - Dashed Box
        const gapBar = mainG.append("rect")
            .attr("x", xBar)
            .attr("fill", "none")
            .attr("stroke", cPurple)
            .attr("stroke-width", 2)
            .attr("stroke-dasharray", "5,5")
            .attr("opacity", 0.8)
            .attr("rx", 8);

        // --- Labels and Annotations ---

        // Labels Group
        const labelsG = svg.append("g");

        // Price Label
        const priceLabel = labelsG.append("text")
            .attr("fill", "white")
            .attr("text-anchor", "middle")
            .attr("font-size", "28px")
            .attr("font-weight", "bold")
            .attr("x", xBar + barWidth / 2);

        // Discount 1 Brace/Label
        const d1Line = labelsG.append("line")
            .attr("stroke", cPink)
            .attr("stroke-width", 3);
        const d1Text = labelsG.append("text")
            .attr("fill", cPink)
            .attr("font-size", "18px")
            .attr("text-anchor", "end");

        // Discount 2 Brace/Label
        const d2Line = labelsG.append("line")
            .attr("stroke", cYellow)
            .attr("stroke-width", 3);
        const d2Text = labelsG.append("text")
            .attr("fill", cYellow)
            .attr("font-size", "18px")
            .attr("text-anchor", "end");

        // Naive Comparison Line
        const naiveG = svg.append("g").attr("opacity", 0);
        naiveG.append("line")
            .attr("id", "naiveLine")
            .attr("stroke", "#ef4444")
            .attr("stroke-opacity", 0.95)
            .attr("stroke-width", 3)
            .attr("stroke-dasharray", "6,4")
            .attr("x1", xBar - 10)
            .attr("x2", xBar + barWidth + 10);

        const naiveText = naiveG.append("text")
            .attr("fill", "#e2e8f0")
            .attr("fill-opacity", 0.95)
            .attr("font-size", "20px")
            .attr("font-weight", "700")
            .attr("text-anchor", "start")
            .text("Mistaken Additional Discount");

        // --- Visualization Logic ---

        function update() {
            // Calculations
            // 1. Start with full height
            // 2. Cut D1 from the top
            // 3. Cut D2 from the top of the remainder

            const fullH = yScale(0) - yScale(1);
            const d1H = fullH * d1;
            const remainder1 = fullH - d1H;
            const d2H = remainder1 * d2; // d2 is a % of the remainder
            const finalPriceH = remainder1 - d2H;
            const totalSavingsPct = (d1 + (1-d1)*d2);
            const finalPricePct = 1 - totalSavingsPct;
            
            // Naive calc for visual comparison
            // Naive thinks we take d2 * fullH off
            const naiveD2H = fullH * d2;
            const gapH = naiveD2H - d2H; // This is the "missing" discount
            const yTop = yScale(1);
            
            // 1. Price Bar (Bottom aligned)
            priceBar
                .attr("width", barWidth)
                .attr("y", yTop + d1H + d2H)
                .attr("height", finalPriceH);
            
            // 2. D1 (Top aligned)
            d1Bar
                .attr("width", barWidth)
                .attr("y", yTop)
                .attr("height", d1H);

            // 3. D2 (Under D1)
            d2Bar
                .attr("width", barWidth)
                .attr("y", yTop + d1H)
                .attr("height", d2H);

            // 4. Gap (Difference between naive and actual D2)
            const naiveCutY = yTop + d1H + naiveD2H;
            
            gapBar
                .attr("width", barWidth)
                .attr("y", yTop + d1H + d2H)
                .attr("height", gapH)
                .attr("opacity", gapH > 3 ? 1 : 0);

            // Update Text Labels
            priceLabel
                .attr("y", yTop + d1H + d2H + finalPriceH / 2 + 6)
                .text(`$${Math.round(finalPricePct * 100)}`);

            // Dynamic annotation lines
            const d1LineX = xBar - 20;
            const d2LineX = xBar - 50;
            
            // D1 Annotation
            d1Line
                .attr("x1", d1LineX).attr("x2", d1LineX)
                .attr("y1", yTop).attr("y2", yTop + d1H);
            d1Text
                .attr("x", d1LineX - 12)
                .attr("y", yTop + d1H/2 + 4)
                .text(Math.round(d1*100) + "%");

            // D2 Annotation
            d2Line
                .attr("x1", d2LineX).attr("x2", d2LineX)
                .attr("y1", yTop + d1H).attr("y2", yTop + d1H + d2H);
            d2Text
                .attr("x", d2LineX - 12)
                .attr("y", yTop + d1H + d2H/2 + 4)
                .text(Math.round(d2*100) + "%");

            // Naive Indicator
            if(gapH > 5) {
                naiveG.attr("opacity", 1);
                naiveG.select("#naiveLine")
                    .attr("y1", naiveCutY)
                    .attr("y2", naiveCutY);
                naiveG.select("text")
                    .attr("x", xBar + barWidth + 20)
                    .attr("y", naiveCutY - 8);
            } else {
                naiveG.attr("opacity", 0);
            }
            
            // Update DOM UI
            document.getElementById('val1').innerText = Math.round(d1 * 100) + "%";
            document.getElementById('val2').innerText = Math.round(d2 * 100) + "%";
            
            const naiveSum = Math.round((d1 + d2) * 100);
            const actualSum = Math.round(totalSavingsPct * 100);
            const gapVal = naiveSum - actualSum;

            document.getElementById('naive-calc').innerHTML = `${Math.round(d1*100)}% + ${Math.round(d2*100)}% = ${naiveSum}%`;
            document.getElementById('actual-calc').innerHTML = `${actualSum}%`;
            document.getElementById('gap-calc').innerHTML = `${gapVal}%`;
        }

        // Event Listeners
        const s1 = document.getElementById('discount1');
        const s2 = document.getElementById('discount2');

        s1.addEventListener('input', (e) => {
            d1 = parseInt(e.target.value) / 100;
            update();
        });

        s2.addEventListener('input', (e) => {
            d2 = parseInt(e.target.value) / 100;
            update();
        });

        // Resize handler
        window.addEventListener('resize', () => {
             // In a real app we'd re-calc scales, but viewBox handles mostly everything here.
        });

        // Init
        update();

    </script>
</body>
</html>
